import math
import pandas as pd
import osmnx as ox
import networkx as nx
import re
import psycopg2
from geopy.distance import geodesic
import tracemalloc
import folium
import webbrowser
import os
from collections import defaultdict
from shapely.geometry import Point, LineString
import geopandas as gpd
import numpy as np
# Al inicio de tu archivo, junto con los otros imports
from http.server import HTTPServer, SimpleHTTPRequestHandler
import threading
# --- 1Ô∏è‚É£ CONFIGURACI√ìN DE CONEXI√ìN ---
DB_CONFIG = {
    'host': 'localhost',      # Cambia si usas otro host
    'dbname': 'appmg',        # Nombre de tu base de datos
    'user': 'postgres',       # Usuario de PostgreSQL
    'port': 5432              # Puerto por defecto
}

# --- 2Ô∏è‚É£ CONSULTA SQL ---
# Cambia el esquema si es necesario; aqu√≠ usamos "public"
QUERY = "SELECT * FROM public.ongs;"

# --- 3Ô∏è‚É£ CONECTAR Y LEER DATOS ---
try:
    conn = psycopg2.connect(**DB_CONFIG)
    df_raw = pd.read_sql(QUERY, conn)
    conn.close()
    print("‚úÖ Datos cargados exitosamente desde PostgreSQL")
except Exception as e:
    raise RuntimeError(f"‚ùå Error al conectar o leer la base de datos: {e}")

print("Encabezados detectados:", list(df_raw.columns))

# --- 4Ô∏è‚É£ Normalizaci√≥n de nombres de columnas ---
def norm_col(c):
    return re.sub(r'[^a-z0-9]', '', c.lower(), flags=re.IGNORECASE)

col_map = {norm_col(c): c for c in df_raw.columns}

# Alias posibles
name_aliases = ['nombre','name','org','organization','ong','institucion','instituci√≥n','nomong','nom_ong']
type_aliases = ['tipo','type','categoria','category']
lat_aliases = ['latitud','latitude','lat','y']
lon_aliases = ['longitud','longitude','lon','lng','x']

def find_column(alias_list):
    for a in alias_list:
        a_norm = re.sub(r'[^a-z0-9]', '', a.lower())
        if a_norm in col_map:
            return col_map[a_norm]
    return None

col_name = find_column(name_aliases)
col_type = find_column(type_aliases)
col_lat  = find_column(lat_aliases)
col_lon  = find_column(lon_aliases)

if col_lat is None or col_lon is None:
    raise ValueError("No se encontraron columnas de latitud/longitud en la tabla 'ongs'.")

# --- 5Ô∏è‚É£ Construir DataFrame normalizado ---
df = df_raw.copy()
df_norm = pd.DataFrame()
df_norm['name'] = df[col_name] if col_name is not None else ''
df_norm['type'] = df[col_type] if col_type is not None else ''

def to_float_series(s):
    s2 = s.astype(str).str.replace(',', '.').str.strip()
    return pd.to_numeric(s2, errors='coerce')

df_norm['lat'] = to_float_series(df[col_lat])
df_norm['lon'] = to_float_series(df[col_lon])

# --- 6Ô∏è‚É£ Eliminar filas sin coordenadas v√°lidas ---
before = len(df_norm)
df_norm = df_norm.dropna(subset=['lat','lon']).reset_index(drop=True)
after = len(df_norm)

print(f"Filas le√≠das: {before}, filas con coordenadas v√°lidas: {after}")

# --- 7Ô∏è‚É£ Inspecci√≥n r√°pida ---
display(df_norm.head(10))
print(df_norm.dtypes)

# --- 8Ô∏è‚É£ Construir lista de waypoints ---
waypoints = [
    {'name': row['name'], 'type': row['type'], 'lat': float(row['lat']), 'lon': float(row['lon'])}
    for _, row in df_norm.iterrows()
]

print(f"Waypoints construidos: {len(waypoints)}. Primeros 10 (si existen):")
for i, w in enumerate(waypoints[:10]):
    print(i+1, w)
 Punto de inicio de prueba
start = start_lat, start_lon = 19.325521, -99.167807 #cdmx

#24.497440, -107.145388 (Mazatl√°n)
def ong_mas_cercana(pos_actual, waypoints):
    """
    Retorna la ONG m√°s cercana a la posici√≥n actual,
    sin importar su ubicaci√≥n (norte, sur, etc.)
    y que no sea frontera.
    """
    # Filtrar solo ONGs (excluyendo fronteras)
    ongs = [
        w for w in waypoints
        if str(w['type']).strip().lower() != 'frontera'
    ]

    if not ongs:
        return None

    # Calcular la distancia geod√©sica de cada ONG respecto al usuario
    for o in ongs:
        o['distancia'] = geodesic(pos_actual, (o['lat'], o['lon'])).kilometers

    # Devolver la ONG m√°s cercana
    return min(ongs, key=lambda x: x['distancia'])

siguiente = ong_mas_cercana(start, waypoints)

if siguiente:
    print(f"ONG m√°s cercana: {siguiente['name']} ({siguiente['distancia']:.2f} km)")
else:
    print("No se encontr√≥ ninguna ONG.")
# Usuario y ONG m√°s cercana
start_point = start  # start ya es (lat, lon)
dest_point = (siguiente['lat'], siguiente['lon'])  # 'siguiente' es la ONG m√°s cercana

# Distancia geod√©sica
distance_km = geodesic(start_point, dest_point).km

# Definir buffer en metros (distancia + margen extra)
buffer_m = (distance_km + 2) * 1000  # +2 km de margen extra

# Descargar grafo solo dentro del buffer desde el punto de inicio
G = ox.graph_from_point(start_point, dist=buffer_m, network_type="drive")

print("Grafo descargado con", len(G.nodes), "nodos y", len(G.edges), "aristas.")
def haversine_heuristic(u, v, G):
    """
    Devuelve la distancia Haversine entre dos nodos de G.
    u, v: nodos
    G: grafo OSMnx con atributos 'y' (lat) y 'x' (lon)
    """
    lat1, lon1 = G.nodes[u]['y'], G.nodes[u]['x']
    lat2, lon2 = G.nodes[v]['y'], G.nodes[v]['x']
    R = 6371000  # Radio de la Tierra en metros
    phi1 = math.radians(lat1)
    phi2 = math.radians(lat2)
    dphi = math.radians(lat2 - lat1)
    dlambda = math.radians(lon2 - lon1)
    a = math.sin(dphi/2)**2 + math.cos(phi1) * math.cos(phi2) * math.sin(dlambda/2)**2
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1-a))
    return R * c
# Nodo m√°s cercano al usuario
orig_node = ox.distance.nearest_nodes(G, start_lon, start_lat)  # (lon, lat)

# Nodo m√°s cercano a la ONG
dest_node = ox.distance.nearest_nodes(G, dest_point[1], dest_point[0])
route = nx.astar_path(
    G,
    orig_node,
    dest_node,
    heuristic=lambda u, v: haversine_heuristic(u, v, G),
    weight='length'
)

print("Ruta calculada con", len(route), "nodos.")
tracemalloc.start()  # iniciar seguimiento de memoria

route = nx.astar_path(
    G,
    orig_node,
    dest_node,
    heuristic=lambda u, v: haversine_heuristic(u, v, G),
    weight='length'
)

current, peak = tracemalloc.get_traced_memory()
print(f"Memoria usada durante el c√°lculo: {current / 1024:.2f} KB (actual), {peak / 1024:.2f} KB (pico)")

tracemalloc.stop()
# --- CONSULTA SQL ---
QUERY_FECHA = "SELECT * FROM public.fecha;"       # Ajusta el esquema si es necesario
QUERY_MUNICIPIO = "SELECT * FROM public.municipio;"

# --- CONEXI√ìN Y LECTURA ---
try:
    conn = psycopg2.connect(**DB_CONFIG)
    
    # Leer tabla 'fecha'
    df_fecha = pd.read_sql(QUERY_FECHA, conn)
    print("‚úÖ Tabla 'fecha' cargada exitosamente")
    
    # Leer tabla 'municipio'
    df_municipio = pd.read_sql(QUERY_MUNICIPIO, conn)
    print("‚úÖ Tabla 'municipio' cargada exitosamente")
    
    conn.close()
except Exception as e:
    raise RuntimeError(f"‚ùå Error al conectar o leer la base de datos: {e}")

# --- Inspecci√≥n r√°pida ---
print("Encabezados de 'fecha':", list(df_fecha.columns))
print(df_fecha.head(), "\n")

print("Encabezados de 'municipio':", list(df_municipio.columns))
print(df_municipio.head())
# Convertimos fecha a datetime y filtramos √∫ltimo mes
df_fecha['fecha'] = pd.to_datetime(df_fecha['fecha'])
ultimo_mes = df_fecha['fecha'].max().month
ultimo_ano = df_fecha['fecha'].max().year
df_ultimo = df_fecha[(df_fecha['fecha'].dt.month == ultimo_mes) &
                     (df_fecha['fecha'].dt.year == ultimo_ano)]
df_ultimo_grado = df_ultimo[['id_municipio', 'grado']]
# --- 1Ô∏è‚É£ ENCONTRAR ONG M√ÅS CERCANA (SI NO EST√Å DEFINIDA) ---
if 'siguiente' not in locals() and 'ong_cercana' not in locals():
    print("üîç Buscando ONG m√°s cercana...")
    
    def ong_mas_cercana(pos_actual, waypoints):
        """
        Retorna la ONG m√°s cercana a la posici√≥n actual
        """
        # Filtrar solo ONGs (excluyendo fronteras)
        ongs = [
            w for w in waypoints
            if str(w.get('type', '')).strip().lower() != 'frontera'
        ]

        if not ongs:
            return None

        # Calcular la distancia geod√©sica de cada ONG respecto al usuario
        for o in ongs:
            o['distancia'] = geodesic(pos_actual, (o['lat'], o['lon'])).kilometers

        # Devolver la ONG m√°s cercana
        return min(ongs, key=lambda x: x['distancia'])

    # Calcular ONG m√°s cercana
    siguiente = ong_mas_cercana(start, waypoints)
    
    if siguiente:
        print(f"‚úÖ ONG m√°s cercana encontrada: {siguiente['name']} ({siguiente['distancia']:.2f} km)")
        ong_cercana = siguiente
    else:
        print("‚ùå No se encontr√≥ ninguna ONG cercana")
        # Crear una ONG dummy para evitar errores
        ong_cercana = {
            'name': 'ONG no disponible',
            'type': 'No disponible', 
            'lat': start[0] + 0.01,
            'lon': start[1] + 0.01,
            'distancia': 0,
            'municipio': 'Desconocido'
        }
else:
    # Si ya existe 'siguiente', √∫sala
    ong_cercana = siguiente if 'siguiente' in locals() else ong_cercana

# --- 2Ô∏è‚É£ CARGAR DATOS DE ONGs CON MUNICIPIO DESDE LA BASE DE DATOS ---

# Modificamos la consulta para obtener el nombre del municipio
QUERY_ONG = """
SELECT o.nom_ong, o.tipo, o.latitud, o.longitud, m.nom_municipio 
FROM public.ongs o
JOIN public.municipio m ON o.id_municipio = m.id_municipio;
"""

try:
    conn = psycopg2.connect(**DB_CONFIG)
    df_ongs = pd.read_sql(QUERY_ONG, conn)
    conn.close()
    print("‚úÖ ONGs cargadas con informaci√≥n de municipio")
except Exception as e:
    print(f"‚ùå Error al cargar ONGs: {e}")
    # Si falla, cargar sin municipio
    QUERY_ONG = "SELECT nom_ong, tipo, latitud, longitud FROM public.ongs;"
    conn = psycopg2.connect(**DB_CONFIG)
    df_ongs = pd.read_sql(QUERY_ONG, conn)
    conn.close()
    df_ongs['nom_municipio'] = 'Desconocido'

# Normalizar los nombres de las columnas
df_ongs.rename(columns={
    'nom_ong': 'name',
    'tipo': 'type', 
    'latitud': 'lat',
    'longitud': 'lon',
    'nom_municipio': 'municipio'
}, inplace=True)

# Convertir a float las coordenadas
df_ongs['lat'] = pd.to_numeric(df_ongs['lat'], errors='coerce')
df_ongs['lon'] = pd.to_numeric(df_ongs['lon'], errors='coerce')

# Eliminar filas sin coordenadas
df_ongs = df_ongs.dropna(subset=['lat', 'lon'])

# Crear la lista de waypoints
waypoints = []
for _, row in df_ongs.iterrows():
    waypoints.append({
        'name': row['name'],
        'type': row['type'],
        'lat': row['lat'],
        'lon': row['lon'],
        'municipio': row['municipio']
    })

print(f"üó∫Ô∏è {len(waypoints)} waypoints cargados con municipio")

# --- 3Ô∏è‚É£ Obtener datos de riesgo de municipios ---
# Asegurarnos de tener los datos de riesgo cargados
try:
    conn = psycopg2.connect(**DB_CONFIG)
    
    # Leer tabla 'fecha' y 'municipio'
    QUERY_FECHA = "SELECT * FROM public.fecha;"
    QUERY_MUNICIPIO = "SELECT * FROM public.municipio;"
    
    df_fecha = pd.read_sql(QUERY_FECHA, conn)
    df_municipio = pd.read_sql(QUERY_MUNICIPIO, conn)
    
    conn.close()
    
    # Procesar datos de riesgo
    df_fecha['fecha'] = pd.to_datetime(df_fecha['fecha'])
    ultimo_mes = df_fecha['fecha'].max().month
    ultimo_ano = df_fecha['fecha'].max().year
    
    df_ultimo = df_fecha[(df_fecha['fecha'].dt.month == ultimo_mes) &
                         (df_fecha['fecha'].dt.year == ultimo_ano)]
    
    # Crear diccionario de riesgo por municipio (por ID)
    riesgo_por_municipio_id = dict(zip(df_ultimo['id_municipio'], df_ultimo['grado']))
    
    # Crear diccionario de riesgo por nombre de municipio
    riesgo_por_municipio_nombre = {}
    for _, row in df_ultimo.iterrows():
        id_municipio = row['id_municipio']
        municipio_nombre = df_municipio[df_municipio['id_municipio'] == id_municipio]['nom_municipio'].iloc[0]
        riesgo_por_municipio_nombre[municipio_nombre] = row['grado']
    
    print("‚úÖ Datos de riesgo cargados correctamente")
    
except Exception as e:
    print(f"‚ùå Error al cargar datos de riesgo: {e}")
    riesgo_por_municipio_nombre = {}

# --- 4Ô∏è‚É£ Funci√≥n simplificada para determinar municipio de ruta ---
def obtener_municipio_por_proximidad(lat, lon, waypoints):
    """
    Determina municipio basado en la ONG m√°s cercana.
    Esto es una aproximaci√≥n - en producci√≥n usar√≠as shapefiles.
    """
    min_dist = float('inf')
    municipio_cercano = 'Desconocido'
    
    for ong in waypoints:
        dist = geodesic((lat, lon), (ong['lat'], ong['lon'])).kilometers
        if dist < min_dist:
            min_dist = dist
            municipio_cercano = ong['municipio']
    
    return municipio_cercano

# --- 5Ô∏è‚É£ Segmentar la ruta por municipios y colores de riesgo ---
route_coords = [(G.nodes[n]['y'], G.nodes[n]['x']) for n in route]

# Crear segmentos de ruta por municipio
segmentos_ruta = []
segmento_actual = []
municipio_actual = None

print("üîç Segmentando ruta por municipios y nivel de riesgo...")
for i, coord in enumerate(route_coords):
    lat, lon = coord
    municipio = obtener_municipio_por_proximidad(lat, lon, waypoints)
    
    # Obtener riesgo para este municipio
    riesgo = riesgo_por_municipio_nombre.get(municipio, 'Desconocido')
    
    if municipio_actual is None:
        municipio_actual = municipio
        segmento_actual.append(coord)
        riesgo_actual = riesgo
    elif municipio == municipio_actual:
        segmento_actual.append(coord)
    else:
        # Cambio de municipio - guardar segmento anterior y empezar nuevo
        if segmento_actual:
            segmentos_ruta.append({
                'coords': segmento_actual.copy(),
                'municipio': municipio_actual,
                'grado_riesgo': riesgo_actual
            })
        
        municipio_actual = municipio
        segmento_actual = [coord]
        riesgo_actual = riesgo

# A√±adir el √∫ltimo segmento
if segmento_actual:
    segmentos_ruta.append({
        'coords': segmento_actual,
        'municipio': municipio_actual,
        'grado_riesgo': riesgo_actual
    })

print(f"üìä Ruta segmentada en {len(segmentos_ruta)} tramos por nivel de riesgo")

# --- 6Ô∏è‚É£ CREAR MAPA CON RUTA DE RIESGO Y PANEL DE PESTA√ëAS ---
def generar_mapa_movil_con_panel_pestanas(ubicacion_usuario, ong_cercana, segmentos_ruta, waypoints, id_usuario, colores_riesgo):
    """Genera HTML optimizado para m√≥viles con panel de pesta√±as desplegable"""
    m = folium.Map(
        location=ubicacion_usuario,
        zoom_start=13,
        tiles="CartoDB positron",
        width='100%', 
        height='98vh'
    )
    
    # Configuraci√≥n para m√≥viles
    m.options['touchZoom'] = True
    m.options['dragging'] = True
    m.options['scrollWheelZoom'] = False
    
    # --- DIBUJAR SEGMENTOS DE RUTA CON COLORES DE RIESGO ---
    print("üé® Dibujando ruta con colores de riesgo...")
    for i, segmento in enumerate(segmentos_ruta):
        color = colores_riesgo.get(segmento['grado_riesgo'], 'gray')
        
        folium.PolyLine(
            segmento['coords'],
            color=color,
            weight=8,
            opacity=0.9,
            tooltip=f"üèôÔ∏è {segmento['municipio']} | üéØ Riesgo: {segmento['grado_riesgo']}"
        ).add_to(m)
        print(f"   üìç Segmento {i+1}: {segmento['municipio']} - {segmento['grado_riesgo']} ({color})")
    
    # --- MARCADOR DEL USUARIO ---
    folium.Marker(
        location=ubicacion_usuario,
        popup=folium.Popup(
            f"""
            <div style='font-size:14px; max-width:250px;'>
                <div style='background:#4A00E0; color:white; padding:8px; border-radius:5px 5px 0 0; margin:-10px -10px 10px -10px;'>
                    <b>üìç Tu Ubicaci√≥n Actual</b>
                </div>
                <p><b>üë§ Usuario:</b> ID {id_usuario}</p>
                <p><b>üéØ Destino:</b> {ong_cercana.get('name', 'No disponible')}</p>
            </div>
            """,
            max_width=300
        ),
        tooltip="Tu ubicaci√≥n actual",
        icon=folium.Icon(color="blue", icon="user", prefix="fa")
    ).add_to(m)
    
    # --- MARCADOR DE LA ONG DESTINO CON FICHA COMPLETA ---
    if ong_cercana and ong_cercana.get('name') != 'ONG no disponible':
        municipio_ong = ong_cercana.get('municipio', 'Desconocido')
        
        # Determinar icono seg√∫n tipo
        tipo_icono = {
            'Albergue': 'bed',
            'Comedor': 'utensils',
            'Frontera': 'flag',
            'default': 'home'
        }
        icono = tipo_icono.get(ong_cercana.get('type', ''), tipo_icono['default'])
        
        folium.Marker(
            location=(ong_cercana['lat'], ong_cercana['lon']),
            popup=folium.Popup(
                f"""
                <div style='font-size:14px; max-width:280px;'>
                    <div style='background:#27ae60; color:white; padding:8px; border-radius:5px 5px 0 0; margin:-10px -10px 10px -10px;'>
                        <b>üè† ONG Destino</b>
                    </div>
                    <p><b>üìå Nombre:</b> {ong_cercana['name']}</p>
                    <p><b>üéØ Tipo:</b> {ong_cercana['type']}</p>
                    <p><b>üèôÔ∏è Municipio:</b> {municipio_ong}</p>
                    <p><b>üìè Distancia:</b> {ong_cercana['distancia']:.1f} km</p>
                    <div style='background:#f8f9fa; padding:5px; border-radius:3px; margin:5px 0;'>
                        <small>üìç {ong_cercana['lat']:.4f}, {ong_cercana['lon']:.4f}</small>
                    </div>
                </div>
                """,
                max_width=320
            ),
            tooltip=f"üéØ ONG Destino: {ong_cercana['name']}",
            icon=folium.Icon(color="green", icon=icono, prefix="fa")
        ).add_to(m)
    
    # --- OTRAS ONGs CON FICHAS INFORMATIVAS COMPLETAS ---
    ongs_marcadas = 0
    for ong in waypoints:
        if ong_cercana and ong['name'] != ong_cercana.get('name', ''):
            municipio_ong = ong.get('municipio', 'Desconocido')
            
            # Determinar color seg√∫n tipo
            color_ong = {
                'Albergue': 'lightblue',
                'Comedor': 'orange',
                'Frontera': 'red',
                'default': 'gray'
            }
            color = color_ong.get(ong.get('type', ''), color_ong['default'])
            
            folium.CircleMarker(
                location=(ong['lat'], ong['lon']),
                radius=8,
                popup=folium.Popup(
                    f"""
                    <div style='font-size:13px; max-width:260px;'>
                        <div style='background:{color}; color:white; padding:6px; border-radius:5px 5px 0 0; margin:-10px -10px 8px -10px;'>
                            <b>üè† Punto de Ayuda</b>
                        </div>
                        <p><b>üìå Nombre:</b> {ong['name']}</p>
                        <p><b>üéØ Tipo:</b> {ong['type']}</p>
                        <p><b>üèôÔ∏è Municipio:</b> {municipio_ong}</p>
                        <div style='background:#f8f9fa; padding:3px; border-radius:3px; margin:3px 0;'>
                            <small>üìç {ong['lat']:.4f}, {ong['lon']:.4f}</small>
                        </div>
                    </div>
                    """,
                    max_width=300
                ),
                tooltip=f"{ong['type']}: {ong['name']}",
                color=color,
                fillColor=color,
                weight=2,
                fillOpacity=0.7
            ).add_to(m)
            ongs_marcadas += 1
    
    print(f"üìç Marcadas {ongs_marcadas} ONGs adicionales con fichas informativas")
    
    # --- LEYENDA MEJORADA CON RIESGOS Y TIPOS DE ONGs ---
    legend_html = '''
    <div style="
        position: fixed; 
        bottom: 20px; 
        left: 10px; 
        width: 200px; 
        height: auto;
        background-color: white; 
        border: 2px solid #4A00E0; 
        z-index: 9999; 
        font-size: 11px;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
    ">
        <h4 style="margin:0 0 8px 0; color:#4A00E0; font-size:12px;">üó∫Ô∏è Leyenda del Mapa</h4>
        
        <div style="margin:5px 0;">
            <p style="margin:2px 0; font-weight:bold;">üéØ Niveles de Riesgo:</p>
            <p style="margin:2px 0;"><span style="color:red; font-weight:bold;">‚óè</span> Alto</p>
            <p style="margin:2px 0;"><span style="color:orange; font-weight:bold;">‚óè</span> Medio</p>
            <p style="margin:2px 0;"><span style="color:green; font-weight:bold;">‚óè</span> Bajo</p>
            <p style="margin:2px 0;"><span style="color:gray; font-weight:bold;">‚óè</span> Desconocido</p>
        </div>
        
        <div style="margin:5px 0;">
            <p style="margin:2px 0; font-weight:bold;">üè† Tipos de ONG:</p>
            <p style="margin:2px 0;"><span style="color:lightblue; font-weight:bold;">‚óè</span> Albergue</p>
            <p style="margin:2px 0;"><span style="color:orange; font-weight:bold;">‚óè</span> Comedor</p>
            <p style="margin:2px 0;"><span style="color:red; font-weight:bold;">‚óè</span> Frontera</p>
        </div>
    </div>
    '''
    m.get_root().html.add_child(folium.Element(legend_html))
    
    # --- PANEL CON PESTA√ëAS DESPLEGABLE ---
    destino_nombre = ong_cercana.get('name', 'No disponible') if ong_cercana else 'No disponible'
    destino_distancia = ong_cercana.get('distancia', 0) if ong_cercana else 0
    destino_tipo = ong_cercana.get('type', 'No disponible') if ong_cercana else 'No disponible'
    destino_municipio = ong_cercana.get('municipio', 'Desconocido') if ong_cercana else 'Desconocido'
    
    # Calcular estad√≠sticas de riesgo de la ruta
    riesgo_alto = sum(1 for s in segmentos_ruta if s['grado_riesgo'] == 'Alto')
    riesgo_medio = sum(1 for s in segmentos_ruta if s['grado_riesgo'] == 'Medio')
    riesgo_bajo = sum(1 for s in segmentos_ruta if s['grado_riesgo'] == 'Bajo')
    
    info_html = f'''
<div style="
    position: fixed; 
    top: 10px; 
    right: 10px; 
    z-index: 9999; 
    font-family: Arial, sans-serif;
">
    <!-- Bot√≥n principal -->
    <div id="info-toggle" style="
        background: #4A00E0; 
        color: white; 
        padding: 8px 15px; 
        border-radius: 20px; 
        cursor: pointer; 
        font-size: 12px; 
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        text-align: center;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    " onclick="toggleInfo()">
        <span>üìã</span>
        <span>Informaci√≥n de Ruta</span>
        <span id="toggle-arrow">‚ñº</span>
    </div>

    <!-- Panel principal -->
    <div id="info-panel" style="
        background: white; 
        border: 2px solid #4A00E0; 
        border-radius: 10px; 
        width: 300px; 
        max-height: 450px; 
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        display: none;
    ">
        <!-- Pesta√±as -->
        <div style="display: flex; border-bottom: 1px solid #ddd; background: #f8f9fa;">
            <div class="tab-button active" onclick="switchTab('destino')" style="flex:1; padding:8px; text-align:center; cursor:pointer; border-bottom: 2px solid #4A00E0;">üéØ Destino</div>
            <div class="tab-button" onclick="switchTab('riesgo')" style="flex:1; padding:8px; text-align:center; cursor:pointer;">üìä Riesgo</div>
            <div class="tab-button" onclick="switchTab('ruta')" style="flex:1; padding:8px; text-align:center; cursor:pointer;">üó∫Ô∏è Ruta</div>
        </div>

        <!-- Contenido de pesta√±as -->
        <div style="padding: 12px; max-height: 350px; overflow-y: auto;">
            
            <!-- Pesta√±a Destino -->
            <div id="tab-destino" class="tab-content">
                <div style="margin-bottom: 15px;">
                    <h4 style="margin:0 0 8px 0; color:#4A00E0; font-size:13px;">üè† ONG Destino</h4>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px; border-radius: 6px;">
                        <p style="margin:0 0 5px 0; font-size:12px; font-weight:bold;">{destino_nombre}</p>
                        <p style="margin:0; font-size:10px; opacity:0.9;">{destino_tipo} ‚Ä¢ {destino_municipio}</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                    <div style="background: #e3f2fd; padding: 6px; border-radius: 4px; text-align: center;">
                        <div style="font-size:10px; color:#1976d2;">üìè Distancia</div>
                        <div style="font-size:12px; font-weight:bold; color:#1976d2;">{destino_distancia:.1f} km</div>
                    </div>
                    <div style="background: #e8f5e8; padding: 6px; border-radius: 4px; text-align: center;">
                        <div style="font-size:10px; color:#388e3c;">üë§ Usuario</div>
                        <div style="font-size:12px; font-weight:bold; color:#388e3c;">ID {id_usuario}</div>
                    </div>
                </div>
            </div>

            <!-- Pesta√±a Riesgo -->
            <div id="tab-riesgo" class="tab-content" style="display: none;">
                <h4 style="margin:0 0 10px 0; color:#4A00E0; font-size:13px;">üìä An√°lisis de Riesgo</h4>
                
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size:11px; font-weight:bold;">Resumen de Segmentos:</span>
                        <span style="font-size:11px; font-weight:bold;">{len(segmentos_ruta)} total</span>
                    </div>
                    
                    <!-- Barra de progreso de riesgo -->
                    <div style="background: #f0f0f0; border-radius: 10px; height: 20px; margin-bottom: 10px; overflow: hidden;">
                        <div style="background: green; width: {(riesgo_bajo/len(segmentos_ruta))*100 if segmentos_ruta else 0}%; height: 100%; float: left;" title="Bajo: {riesgo_bajo}"></div>
                        <div style="background: orange; width: {(riesgo_medio/len(segmentos_ruta))*100 if segmentos_ruta else 0}%; height: 100%; float: left;" title="Medio: {riesgo_medio}"></div>
                        <div style="background: red; width: {(riesgo_alto/len(segmentos_ruta))*100 if segmentos_ruta else 0}%; height: 100%; float: left;" title="Alto: {riesgo_alto}"></div>
                    </div>
                    
                    <!-- Leyenda de colores -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; text-align: center;">
                        <div>
                            <div style="color: green; font-size:12px;">‚óè {riesgo_bajo}</div>
                            <div style="font-size:9px; color:#666;">Bajo</div>
                        </div>
                        <div>
                            <div style="color: orange; font-size:12px;">‚óè {riesgo_medio}</div>
                            <div style="font-size:9px; color:#666;">Medio</div>
                        </div>
                        <div>
                            <div style="color: red; font-size:12px;">‚óè {riesgo_alto}</div>
                            <div style="font-size:9px; color:#666;">Alto</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pesta√±a Ruta -->
            <div id="tab-ruta" class="tab-content" style="display: none;">
                <h4 style="margin:0 0 10px 0; color:#4A00E0; font-size:13px;">üó∫Ô∏è Detalles de Ruta</h4>
                
                <div style="margin-bottom: 10px;">
                    <div style="font-size:11px; margin-bottom: 5px;"><b>ONGs disponibles:</b> {len(waypoints)}</div>
                    <div style="font-size:11px; margin-bottom: 5px;"><b>Segmentos calculados:</b> {len(segmentos_ruta)}</div>
                </div>

                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 5px; padding: 8px;">
                    <div style="font-size:11px; font-weight:bold; margin-bottom: 5px;">Municipios en ruta:</div>
                    {' '.join([f'<div style="font-size:10px; margin:3px 0; padding:3px; border-left: 3px solid {colores_riesgo.get(s["grado_riesgo"], "gray")}; background: #f8f9fa;">{s["municipio"]} <span style="float:right; color:{colores_riesgo.get(s["grado_riesgo"], "gray")};">{s["grado_riesgo"]}</span></div>' for s in segmentos_ruta])}
                </div>
            </div>

        </div>
    </div>
</div>

<style>
.tab-button {{
    transition: all 0.3s ease;
}}
.tab-button:hover {{
    background: #e3f2fd;
}}
.tab-button.active {{
    background: #4A00E0;
    color: white;
}}
.tab-content {{
    animation: fadeIn 0.3s ease;
}}
@keyframes fadeIn {{
    from {{ opacity: 0; }}
    to {{ opacity: 1; }}
}}
</style>

<script>
function toggleInfo() {{
    var panel = document.getElementById('info-panel');
    var arrow = document.getElementById('toggle-arrow');
    if (panel.style.display === 'none' || panel.style.display === '') {{
        panel.style.display = 'block';
        arrow.innerHTML = '‚ñ≤';
    }} else {{
        panel.style.display = 'none';
        arrow.innerHTML = '‚ñº';
    }}
}}

function switchTab(tabName) {{
    // Ocultar todos los contenidos
    var contents = document.getElementsByClassName('tab-content');
    for (var i = 0; i < contents.length; i++) {{
        contents[i].style.display = 'none';
    }}
    
    // Remover clase active de todos los botones
    var buttons = document.getElementsByClassName('tab-button');
    for (var i = 0; i < buttons.length; i++) {{
        buttons[i].classList.remove('active');
    }}
    
    // Mostrar contenido seleccionado y activar bot√≥n
    document.getElementById('tab-' + tabName).style.display = 'block';
    event.target.classList.add('active');
}}

// Cerrar al hacer clic fuera
document.addEventListener('click', function(event) {{
    var panel = document.getElementById('info-panel');
    var button = document.getElementById('info-toggle');
    if (!panel.contains(event.target) && !button.contains(event.target)) {{
        panel.style.display = 'none';
        document.getElementById('toggle-arrow').innerHTML = '‚ñº';
    }}
}});

// Inicializar con primera pesta√±a activa
document.addEventListener('DOMContentLoaded', function() {{
    switchTab('destino');
}});
</script>
'''
    m.get_root().html.add_child(folium.Element(info_html))
    
    # Guardar con meta tags para m√≥vil
    archivo_html = f"ruta_movil_{id_usuario}.html"
    html_content = m.get_root().render()
    
    # Meta tags optimizados para m√≥vil
    html_content = html_content.replace('<head>', '''
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <style>
            body { 
                margin: 0; 
                padding: 0; 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            }
            #map { 
                position: absolute; 
                top: 0; 
                bottom: 0; 
                width: 100%; 
            }
            .leaflet-popup-content { 
                font-size: 14px; 
                line-height: 1.4;
            }
            .leaflet-control-zoom {
                margin-top: 180px !important;
            }
            .leaflet-popup-content-wrapper {
                border-radius: 8px;
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            }
        </style>
    ''')
    
    with open(archivo_html, 'w', encoding='utf-8') as f:
        f.write(html_content)
    
    print(f"‚úÖ Mapa con panel de pesta√±as generado: {archivo_html}")
    return archivo_html

# --- 7Ô∏è‚É£ CONFIGURACI√ìN FINAL Y EJECUCI√ìN ---
def iniciar_servidor_local(puerto=8080):
    """Inicia un servidor local para servir el mapa"""
    def servir():
        handler = SimpleHTTPRequestHandler
        with HTTPServer(('0.0.0.0', puerto), handler) as httpd:
            print(f"üåê Servidor local ejecut√°ndose en: http://localhost:{puerto}")
            print(f"üì± Disponible en la red: http://{obtener_ip_local()}:{puerto}")
            httpd.serve_forever()
    
    thread = threading.Thread(target=servir, daemon=True)
    thread.start()
    return f"http://localhost:{puerto}/"

def obtener_ip_local():
    """Obtiene la IP local para acceso desde otros dispositivos"""
    try:
        import socket
        hostname = socket.gethostname()
        local_ip = socket.gethostbyname(hostname)
        return local_ip
    except:
        return "localhost"

# --- CONFIGURACI√ìN DEL ID DE USUARIO (TEMPORAL) ---
if 'id_usuario_actual' not in locals():
    id_usuario_actual = 1
    print(f"üë§ Usuario temporal asignado: ID {id_usuario_actual}")

# --- DEFINIR COLORES DE RIESGO ---
colores_riesgo = {
    'Alto': 'red',
    'Medio': 'orange', 
    'Bajo': 'green',
    'Desconocido': 'gray'
}

# --- GENERAR Y SERVIR EL MAPA M√ìVIL CON PANEL DE PESTA√ëAS ---
print("üöÄ Generando mapa m√≥vil con panel de pesta√±as desplegable...")
archivo_mapa = generar_mapa_movil_con_panel_pestanas(
    start, 
    ong_cercana, 
    segmentos_ruta, 
    waypoints, 
    id_usuario_actual,
    colores_riesgo
)

# Iniciar servidor
url_base = iniciar_servidor_local(8080)

print(f"\n{'='*60}")
print("üì± **MAPA CON PANEL DE PESTA√ëAS DESPLEGABLE**")
print(f"{'='*60}")
print(f"üìç URL local: {url_base}{archivo_mapa}")
print(f"üåê URL red local: http://{obtener_ip_local()}:8080/{archivo_mapa}")
print(f"üìÅ Archivo: {archivo_mapa}")
print(f"üéØ ONG destino: {ong_cercana.get('name', 'No disponible')}")
print(f"üìå Tipo: {ong_cercana.get('type', 'No disponible')}")
print(f"üèôÔ∏è Municipio: {ong_cercana.get('municipio', 'Desconocido')}")
print(f"üìè Distancia: {ong_cercana.get('distancia', 0):.1f} km")
print(f"üìä Segmentos de riesgo: {len(segmentos_ruta)}")
print(f"üìç ONGs en mapa: {len(waypoints)}")
print(f"{'='*60}")
print("üí° **Caracter√≠sticas del mapa:**")
print("‚Ä¢ üé® Ruta segmentada por nivel de riesgo (rojo/naranja/verde)")
print("‚Ä¢ üìã Panel desplegable con pesta√±as organizadas")
print("‚Ä¢ üèôÔ∏è Informaci√≥n completa de municipios y ONGs")
print("‚Ä¢ üìä An√°lisis visual de riesgo con barras de progreso")
print("‚Ä¢ üó∫Ô∏è Leyenda completa con colores y s√≠mbolos")
print("‚Ä¢ üì± Optimizado para pantallas t√°ctiles")
print(f"{'='*60}")

# Opcional: Abrir autom√°ticamente en el navegador
try:
    webbrowser.open(f"{url_base}{archivo_mapa}")
    print("üåê Abriendo mapa en navegador...")
except:
    pass
def find_sorted_ongs(start, df, min_lat=None):
    candidates = []

    for _, row in df.iterrows():
        if str(row['type']).strip().lower() != 'frontera':
            # Filtrar por latitud si se indica
            if min_lat is None or row["lat"] > min_lat:
                ong_point = (row["lat"], row["lon"])
                dist = geodesic(start, ong_point).km
                candidates.append({
                    "name": row["name"],
                    "lat": row["lat"],
                    "lon": row["lon"],
                    "type": row["type"],
                    "distancia": dist
                })

    # Ordenar por distancia
    candidates.sort(key=lambda x: x['distancia'])
    return candidates
# Obtener ONGs ordenadas por distancia desde el usuario
ongs_ordenadas = find_sorted_ongs(start, df_norm)  # df_norm es tu DataFrame o ajusta a waypoints si quieres

if len(ongs_ordenadas) == 0:
    print("No hay ONGs disponibles. Dir√≠gete a la frontera.")
elif len(ongs_ordenadas) == 1:
    ong = ongs_ordenadas[0]
    print(f"Siguiente ONG: {ong['name']} ({ong['distancia']:.1f} km) - Tipo: {ong['type']}")
else:
    # Elegir la segunda ONG m√°s cercana
    segunda = ongs_ordenadas[1]
    print(f"Siguiente recomendaci√≥n: {segunda['name']} ({segunda['distancia']:.1f} km) - Tipo: {segunda['type']}")
# --- 8Ô∏è‚É£ SISTEMA DE RECOMENDACI√ìN DE ONGs ---
def find_sorted_ongs(start, waypoints_list, min_lat=None):
    """
    Encuentra ONGs ordenadas por distancia, excluyendo fronteras
    """
    candidates = []

    for ong in waypoints_list:
        if str(ong.get('type', '')).strip().lower() != 'frontera':
            # Filtrar por latitud si se indica
            if min_lat is None or ong["lat"] > min_lat:
                ong_point = (ong["lat"], ong["lon"])
                dist = geodesic(start, ong_point).km
                candidates.append({
                    "name": ong["name"],
                    "lat": ong["lat"],
                    "lon": ong["lon"],
                    "type": ong["type"],
                    "municipio": ong.get("municipio", "Desconocido"),
                    "distancia": dist
                })

    # Ordenar por distancia
    candidates.sort(key=lambda x: x['distancia'])
    return candidates

# Obtener ONGs ordenadas por distancia desde el usuario
print("üîç Calculando recomendaciones de ONGs...")
ongs_ordenadas = find_sorted_ongs(start, waypoints)

# Determinar la siguiente recomendaci√≥n
if len(ongs_ordenadas) == 0:
    print("‚ùå No hay ONGs disponibles. Dir√≠gete a la frontera.")
    siguiente_recomendacion = None
    mensaje_recomendacion = "No hay ONGs disponibles"
elif len(ongs_ordenadas) == 1:
    siguiente_recomendacion = ongs_ordenadas[0]
    mensaje_recomendacion = f"√önica ONG disponible: {siguiente_recomendacion['name']}"
    print(f"üìç √önica ONG disponible: {siguiente_recomendacion['name']} ({siguiente_recomendacion['distancia']:.1f} km)")
else:
    # Elegir la segunda ONG m√°s cercana como recomendaci√≥n
    siguiente_recomendacion = ongs_ordenadas[1]
    mensaje_recomendacion = f"Recomendaci√≥n: {siguiente_recomendacion['name']}"
    print(f"üìç Recomendaci√≥n: {siguiente_recomendacion['name']} ({siguiente_recomendacion['distancia']:.1f} km)")

# Preparar datos para mostrar en el panel
ongs_cercanas = ongs_ordenadas[:5]  # Mostrar las 5 m√°s cercanas

# --- MODIFICAR LA FUNCI√ìN DEL MAPA PARA INCLUIR PESTA√ëA DE RECOMENDACI√ìN ---
def generar_mapa_movil_con_recomendaciones(ubicacion_usuario, ong_cercana, segmentos_ruta, waypoints, id_usuario, colores_riesgo, ongs_cercanas, siguiente_recomendacion):
    """Genera HTML optimizado para m√≥viles con panel de pesta√±as incluyendo recomendaciones"""
    m = folium.Map(
        location=ubicacion_usuario,
        zoom_start=13,
        tiles="CartoDB positron",
        width='100%', 
        height='98vh'
    )
    
    # Configuraci√≥n para m√≥viles
    m.options['touchZoom'] = True
    m.options['dragging'] = True
    m.options['scrollWheelZoom'] = False
    
    # --- DIBUJAR SEGMENTOS DE RUTA CON COLORES DE RIESGO ---
    print("üé® Dibujando ruta con colores de riesgo...")
    for i, segmento in enumerate(segmentos_ruta):
        color = colores_riesgo.get(segmento['grado_riesgo'], 'gray')
        
        folium.PolyLine(
            segmento['coords'],
            color=color,
            weight=8,
            opacity=0.9,
            tooltip=f"üèôÔ∏è {segmento['municipio']} | üéØ Riesgo: {segmento['grado_riesgo']}"
        ).add_to(m)
        print(f"   üìç Segmento {i+1}: {segmento['municipio']} - {segmento['grado_riesgo']} ({color})")
    
    # --- MARCADOR DEL USUARIO ---
    folium.Marker(
        location=ubicacion_usuario,
        popup=folium.Popup(
            f"""
            <div style='font-size:14px; max-width:250px;'>
                <div style='background:#4A00E0; color:white; padding:8px; border-radius:5px 5px 0 0; margin:-10px -10px 10px -10px;'>
                    <b>üìç Tu Ubicaci√≥n Actual</b>
                </div>
                <p><b>üë§ Usuario:</b> ID {id_usuario}</p>
                <p><b>üéØ Destino:</b> {ong_cercana.get('name', 'No disponible')}</p>
            </div>
            """,
            max_width=300
        ),
        tooltip="Tu ubicaci√≥n actual",
        icon=folium.Icon(color="blue", icon="user", prefix="fa")
    ).add_to(m)
    
    # --- MARCADOR DE LA ONG DESTINO CON FICHA COMPLETA ---
    if ong_cercana and ong_cercana.get('name') != 'ONG no disponible':
        municipio_ong = ong_cercana.get('municipio', 'Desconocido')
        
        # Determinar icono seg√∫n tipo
        tipo_icono = {
            'Albergue': 'bed',
            'Comedor': 'utensils',
            'Frontera': 'flag',
            'default': 'home'
        }
        icono = tipo_icono.get(ong_cercana.get('type', ''), tipo_icono['default'])
        
        folium.Marker(
            location=(ong_cercana['lat'], ong_cercana['lon']),
            popup=folium.Popup(
                f"""
                <div style='font-size:14px; max-width:280px;'>
                    <div style='background:#27ae60; color:white; padding:8px; border-radius:5px 5px 0 0; margin:-10px -10px 10px -10px;'>
                        <b>üè† ONG Destino</b>
                    </div>
                    <p><b>üìå Nombre:</b> {ong_cercana['name']}</p>
                    <p><b>üéØ Tipo:</b> {ong_cercana['type']}</p>
                    <p><b>üèôÔ∏è Municipio:</b> {municipio_ong}</p>
                    <p><b>üìè Distancia:</b> {ong_cercana['distancia']:.1f} km</p>
                    <div style='background:#f8f9fa; padding:5px; border-radius:3px; margin:5px 0;'>
                        <small>üìç {ong_cercana['lat']:.4f}, {ong_cercana['lon']:.4f}</small>
                    </div>
                </div>
                """,
                max_width=320
            ),
            tooltip=f"üéØ ONG Destino: {ong_cercana['name']}",
            icon=folium.Icon(color="green", icon=icono, prefix="fa")
        ).add_to(m)
    
    # --- MARCADOR DE LA SIGUIENTE RECOMENDACI√ìN ---
    if siguiente_recomendacion:
        folium.Marker(
            location=(siguiente_recomendacion['lat'], siguiente_recomendacion['lon']),
            popup=folium.Popup(
                f"""
                <div style='font-size:14px; max-width:280px;'>
                    <div style='background:#FF9800; color:white; padding:8px; border-radius:5px 5px 0 0; margin:-10px -10px 10px -10px;'>
                        <b>‚≠ê Pr√≥xima Recomendaci√≥n</b>
                    </div>
                    <p><b>üìå Nombre:</b> {siguiente_recomendacion['name']}</p>
                    <p><b>üéØ Tipo:</b> {siguiente_recomendacion['type']}</p>
                    <p><b>üèôÔ∏è Municipio:</b> {siguiente_recomendacion.get('municipio', 'Desconocido')}</p>
                    <p><b>üìè Distancia:</b> {siguiente_recomendacion['distancia']:.1f} km</p>
                    <div style='background:#fff3e0; padding:5px; border-radius:3px; margin:5px 0;'>
                        <small>üí° Recomendaci√≥n del sistema</small>
                    </div>
                </div>
                """,
                max_width=320
            ),
            tooltip=f"‚≠ê Recomendaci√≥n: {siguiente_recomendacion['name']}",
            icon=folium.Icon(color="orange", icon="star", prefix="fa")
        ).add_to(m)
    
    # --- OTRAS ONGs CON FICHAS INFORMATIVAS COMPLETAS ---
    ongs_marcadas = 0
    for ong in waypoints:
        if ong_cercana and ong['name'] != ong_cercana.get('name', '') and (not siguiente_recomendacion or ong['name'] != siguiente_recomendacion.get('name', '')):
            municipio_ong = ong.get('municipio', 'Desconocido')
            
            # Determinar color seg√∫n tipo
            color_ong = {
                'Albergue': 'lightblue',
                'Comedor': 'orange',
                'Frontera': 'red',
                'default': 'gray'
            }
            color = color_ong.get(ong.get('type', ''), color_ong['default'])
            
            folium.CircleMarker(
                location=(ong['lat'], ong['lon']),
                radius=8,
                popup=folium.Popup(
                    f"""
                    <div style='font-size:13px; max-width:260px;'>
                        <div style='background:{color}; color:white; padding:6px; border-radius:5px 5px 0 0; margin:-10px -10px 8px -10px;'>
                            <b>üè† Punto de Ayuda</b>
                        </div>
                        <p><b>üìå Nombre:</b> {ong['name']}</p>
                        <p><b>üéØ Tipo:</b> {ong['type']}</p>
                        <p><b>üèôÔ∏è Municipio:</b> {municipio_ong}</p>
                        <div style='background:#f8f9fa; padding:3px; border-radius:3px; margin:3px 0;'>
                            <small>üìç {ong['lat']:.4f}, {ong['lon']:.4f}</small>
                        </div>
                    </div>
                    """,
                    max_width=300
                ),
                tooltip=f"{ong['type']}: {ong['name']}",
                color=color,
                fillColor=color,
                weight=2,
                fillOpacity=0.7
            ).add_to(m)
            ongs_marcadas += 1
    
    print(f"üìç Marcadas {ongs_marcadas} ONGs adicionales con fichas informativas")
    
    # --- LEYENDA MEJORADA CON RECOMENDACIONES ---
    legend_html = '''
    <div style="
        position: fixed; 
        bottom: 20px; 
        left: 10px; 
        width: 220px; 
        height: auto;
        background-color: white; 
        border: 2px solid #4A00E0; 
        z-index: 9999; 
        font-size: 11px;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
    ">
        <h4 style="margin:0 0 8px 0; color:#4A00E0; font-size:12px;">üó∫Ô∏è Leyenda del Mapa</h4>
        
        <div style="margin:5px 0;">
            <p style="margin:2px 0; font-weight:bold;">üéØ Niveles de Riesgo:</p>
            <p style="margin:2px 0;"><span style="color:red; font-weight:bold;">‚óè</span> Alto</p>
            <p style="margin:2px 0;"><span style="color:orange; font-weight:bold;">‚óè</span> Medio</p>
            <p style="margin:2px 0;"><span style="color:green; font-weight:bold;">‚óè</span> Bajo</p>
            <p style="margin:2px 0;"><span style="color:gray; font-weight:bold;">‚óè</span> Desconocido</p>
        </div>
        
        <div style="margin:5px 0;">
            <p style="margin:2px 0; font-weight:bold;">üìç Marcadores:</p>
            <p style="margin:2px 0;"><span style="color:blue;">üìç</span> Tu ubicaci√≥n</p>
            <p style="margin:2px 0;"><span style="color:green;">üè†</span> ONG destino</p>
            <p style="margin:2px 0;"><span style="color:orange;">‚≠ê</span> Recomendaci√≥n</p>
            <p style="margin:2px 0;"><span style="color:lightblue;">‚óè</span> Albergue</p>
            <p style="margin:2px 0;"><span style="color:orange;">‚óè</span> Comedor</p>
        </div>
    </div>
    '''
    m.get_root().html.add_child(folium.Element(legend_html))
    
    # --- PANEL CON PESTA√ëAS INCLUYENDO RECOMENDACI√ìN ---
    destino_nombre = ong_cercana.get('name', 'No disponible') if ong_cercana else 'No disponible'
    destino_distancia = ong_cercana.get('distancia', 0) if ong_cercana else 0
    destino_tipo = ong_cercana.get('type', 'No disponible') if ong_cercana else 'No disponible'
    destino_municipio = ong_cercana.get('municipio', 'Desconocido') if ong_cercana else 'Desconocido'
    
    # Calcular estad√≠sticas de riesgo de la ruta
    riesgo_alto = sum(1 for s in segmentos_ruta if s['grado_riesgo'] == 'Alto')
    riesgo_medio = sum(1 for s in segmentos_ruta if s['grado_riesgo'] == 'Medio')
    riesgo_bajo = sum(1 for s in segmentos_ruta if s['grado_riesgo'] == 'Bajo')
    
    # Preparar datos de recomendaci√≥n
    if siguiente_recomendacion:
        rec_nombre = siguiente_recomendacion['name']
        rec_distancia = siguiente_recomendacion['distancia']
        rec_tipo = siguiente_recomendacion['type']
        rec_municipio = siguiente_recomendacion.get('municipio', 'Desconocido')
    else:
        rec_nombre = "No disponible"
        rec_distancia = 0
        rec_tipo = "No disponible"
        rec_municipio = "Desconocido"
    
    # Crear HTML para otras ONGs cercanas (sin caracteres especiales problem√°ticos)
    otras_ongs_html = ""
    if len(ongs_cercanas) > 2:
        for ong in ongs_cercanas[2:7]:
            otras_ongs_html += f"""
            <div style="font-size:10px; margin:4px 0; padding:5px; background:#f8f9fa; border-radius:4px; border-left: 3px solid #4A00E0;">
                <div style="font-weight:bold;">{ong['name']}</div>
                <div style="color:#666; font-size:9px;">{ong['type']} - {ong.get('municipio', 'Desconocido')} - {ong['distancia']:.1f} km</div>
            </div>
            """
    else:
        otras_ongs_html = '<div style="font-size:10px; color:#666; text-align:center;">No hay m√°s ONGs cercanas</div>'
    
    # Crear HTML para municipios en ruta (sin caracteres especiales problem√°ticos)
    municipios_html = ""
    for segmento in segmentos_ruta:
        color = colores_riesgo.get(segmento['grado_riesgo'], 'gray')
        municipios_html += f'<div style="font-size:10px; margin:3px 0; padding:3px; border-left: 3px solid {color}; background: #f8f9fa;">{segmento["municipio"]} <span style="float:right; color:{color};">{segmento["grado_riesgo"]}</span></div>'
    
    info_html = f'''
<div style="
    position: fixed; 
    top: 10px; 
    right: 10px; 
    z-index: 9999; 
    font-family: Arial, sans-serif;
">
    <!-- Bot√≥n principal -->
    <div id="info-toggle" style="
        background: #4A00E0; 
        color: white; 
        padding: 8px 15px; 
        border-radius: 20px; 
        cursor: pointer; 
        font-size: 12px; 
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        text-align: center;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    " onclick="toggleInfo()">
        <span>üìã</span>
        <span>Informaci√≥n de Ruta</span>
        <span id="toggle-arrow">‚ñº</span>
    </div>

    <!-- Panel principal -->
    <div id="info-panel" style="
        background: white; 
        border: 2px solid #4A00E0; 
        border-radius: 10px; 
        width: 320px; 
        max-height: 500px; 
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        display: none;
    ">
        <!-- Pesta√±as -->
        <div style="display: flex; border-bottom: 1px solid #ddd; background: #f8f9fa;">
            <div class="tab-button active" onclick="switchTab('destino')" style="flex:1; padding:8px; text-align:center; cursor:pointer; border-bottom: 2px solid #4A00E0; font-size:11px;">üéØ Destino</div>
            <div class="tab-button" onclick="switchTab('riesgo')" style="flex:1; padding:8px; text-align:center; cursor:pointer; font-size:11px;">üìä Riesgo</div>
            <div class="tab-button" onclick="switchTab('recomendacion')" style="flex:1; padding:8px; text-align:center; cursor:pointer; font-size:11px;">‚≠ê Recomendaci√≥n</div>
            <div class="tab-button" onclick="switchTab('ruta')" style="flex:1; padding:8px; text-align:center; cursor:pointer; font-size:11px;">üó∫Ô∏è Ruta</div>
        </div>

        <!-- Contenido de pesta√±as -->
        <div style="padding: 12px; max-height: 400px; overflow-y: auto;">
            
            <!-- Pesta√±a Destino -->
            <div id="tab-destino" class="tab-content">
                <div style="margin-bottom: 15px;">
                    <h4 style="margin:0 0 8px 0; color:#4A00E0; font-size:13px;">üè† ONG Destino Actual</h4>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px; border-radius: 6px;">
                        <p style="margin:0 0 5px 0; font-size:12px; font-weight:bold;">{destino_nombre}</p>
                        <p style="margin:0; font-size:10px; opacity:0.9;">{destino_tipo} - {destino_municipio}</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                    <div style="background: #e3f2fd; padding: 6px; border-radius: 4px; text-align: center;">
                        <div style="font-size:10px; color:#1976d2;">üìè Distancia</div>
                        <div style="font-size:12px; font-weight:bold; color:#1976d2;">{destino_distancia:.1f} km</div>
                    </div>
                    <div style="background: #e8f5e8; padding: 6px; border-radius: 4px; text-align: center;">
                        <div style="font-size:10px; color:#388e3c;">üë§ Usuario</div>
                        <div style="font-size:12px; font-weight:bold; color:#388e3c;">ID {id_usuario}</div>
                    </div>
                </div>
            </div>

            <!-- Pesta√±a Riesgo -->
            <div id="tab-riesgo" class="tab-content" style="display: none;">
                <h4 style="margin:0 0 10px 0; color:#4A00E0; font-size:13px;">üìä An√°lisis de Riesgo</h4>
                
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size:11px; font-weight:bold;">Resumen de Segmentos:</span>
                        <span style="font-size:11px; font-weight:bold;">{len(segmentos_ruta)} total</span>
                    </div>
                    
                    <!-- Barra de progreso de riesgo -->
                    <div style="background: #f0f0f0; border-radius: 10px; height: 20px; margin-bottom: 10px; overflow: hidden;">
                        <div style="background: green; width: {(riesgo_bajo/len(segmentos_ruta))*100 if segmentos_ruta else 0}%; height: 100%; float: left;" title="Bajo: {riesgo_bajo}"></div>
                        <div style="background: orange; width: {(riesgo_medio/len(segmentos_ruta))*100 if segmentos_ruta else 0}%; height: 100%; float: left;" title="Medio: {riesgo_medio}"></div>
                        <div style="background: red; width: {(riesgo_alto/len(segmentos_ruta))*100 if segmentos_ruta else 0}%; height: 100%; float: left;" title="Alto: {riesgo_alto}"></div>
                    </div>
                    
                    <!-- Leyenda de colores -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; text-align: center;">
                        <div>
                            <div style="color: green; font-size:12px;">‚óè {riesgo_bajo}</div>
                            <div style="font-size:9px; color:#666;">Bajo</div>
                        </div>
                        <div>
                            <div style="color: orange; font-size:12px;">‚óè {riesgo_medio}</div>
                            <div style="font-size:9px; color:#666;">Medio</div>
                        </div>
                        <div>
                            <div style="color: red; font-size:12px;">‚óè {riesgo_alto}</div>
                            <div style="font-size:9px; color:#666;">Alto</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pesta√±a Recomendaci√≥n -->
            <div id="tab-recomendacion" class="tab-content" style="display: none;">
                <h4 style="margin:0 0 10px 0; color:#4A00E0; font-size:13px;">‚≠ê Pr√≥xima Recomendaci√≥n</h4>
                
                <div style="margin-bottom: 15px;">
                    <div style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                        <p style="margin:0 0 5px 0; font-size:12px; font-weight:bold;">{rec_nombre}</p>
                        <p style="margin:0; font-size:10px; opacity:0.9;">{rec_tipo} - {rec_municipio}</p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                        <div style="background: #fff3e0; padding: 6px; border-radius: 4px; text-align: center;">
                            <div style="font-size:10px; color:#EF6C00;">üìè Distancia</div>
                            <div style="font-size:12px; font-weight:bold; color:#EF6C00;">{rec_distancia:.1f} km</div>
                        </div>
                        <div style="background: #e8f5e8; padding: 6px; border-radius: 4px; text-align: center;">
                            <div style="font-size:10px; color:#388e3c;">üéØ Tipo</div>
                            <div style="font-size:12px; font-weight:bold; color:#388e3c;">{rec_tipo}</div>
                        </div>
                    </div>

                    <div style="background: #e3f2fd; padding: 8px; border-radius: 5px; margin-bottom: 10px;">
                        <p style="margin:0; font-size:10px; color:#1976d2; font-weight:bold;">üí° Recomendaci√≥n del Sistema</p>
                        <p style="margin:5px 0 0 0; font-size:9px; color:#1976d2;">Esta ONG ha sido seleccionada como tu pr√≥xima parada recomendada basada en proximidad y disponibilidad.</p>
                    </div>
                </div>

                <div style="border-top: 1px solid #eee; padding-top: 10px;">
                    <h5 style="margin:0 0 8px 0; color:#4A00E0; font-size:12px;">üìç Otras ONGs Cercanas</h5>
                    <div style="max-height: 150px; overflow-y: auto;">
                        {otras_ongs_html}
                    </div>
                </div>
            </div>

            <!-- Pesta√±a Ruta -->
            <div id="tab-ruta" class="tab-content" style="display: none;">
                <h4 style="margin:0 0 10px 0; color:#4A00E0; font-size:13px;">üó∫Ô∏è Detalles de Ruta</h4>
                
                <div style="margin-bottom: 10px;">
                    <div style="font-size:11px; margin-bottom: 5px;"><b>ONGs disponibles:</b> {len(waypoints)}</div>
                    <div style="font-size:11px; margin-bottom: 5px;"><b>Segmentos calculados:</b> {len(segmentos_ruta)}</div>
                </div>

                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 5px; padding: 8px;">
                    <div style="font-size:11px; font-weight:bold; margin-bottom: 5px;">Municipios en ruta:</div>
                    {municipios_html}
                </div>
            </div>

        </div>
    </div>
</div>

<style>
.tab-button {{
    transition: all 0.3s ease;
}}
.tab-button:hover {{
    background: #e3f2fd;
}}
.tab-button.active {{
    background: #4A00E0;
    color: white;
}}
.tab-content {{
    animation: fadeIn 0.3s ease;
}}
@keyframes fadeIn {{
    from {{ opacity: 0; }}
    to {{ opacity: 1; }}
}}
</style>

<script>
function toggleInfo() {{
    var panel = document.getElementById('info-panel');
    var arrow = document.getElementById('toggle-arrow');
    if (panel.style.display === 'none' || panel.style.display === '') {{
        panel.style.display = 'block';
        arrow.innerHTML = '‚ñ≤';
    }} else {{
        panel.style.display = 'none';
        arrow.innerHTML = '‚ñº';
    }}
}}

function switchTab(tabName) {{
    // Ocultar todos los contenidos
    var contents = document.getElementsByClassName('tab-content');
    for (var i = 0; i < contents.length; i++) {{
        contents[i].style.display = 'none';
    }}
    
    // Remover clase active de todos los botones
    var buttons = document.getElementsByClassName('tab-button');
    for (var i = 0; i < buttons.length; i++) {{
        buttons[i].classList.remove('active');
    }}
    
    // Mostrar contenido seleccionado y activar bot√≥n
    document.getElementById('tab-' + tabName).style.display = 'block';
    event.target.classList.add('active');
}}

// Cerrar al hacer clic fuera
document.addEventListener('click', function(event) {{
    var panel = document.getElementById('info-panel');
    var button = document.getElementById('info-toggle');
    if (!panel.contains(event.target) && !button.contains(event.target)) {{
        panel.style.display = 'none';
        document.getElementById('toggle-arrow').innerHTML = '‚ñº';
    }}
}});

// Inicializar con primera pesta√±a activa
document.addEventListener('DOMContentLoaded', function() {{
    switchTab('destino');
}});
</script>
'''
    m.get_root().html.add_child(folium.Element(info_html))
    
    # Guardar con meta tags para m√≥vil
    archivo_html = f"ruta_movil_{id_usuario}.html"
    html_content = m.get_root().render()
    
    # Meta tags optimizados para m√≥vil
    html_content = html_content.replace('<head>', '''
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <style>
            body { 
                margin: 0; 
                padding: 0; 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            }
            #map { 
                position: absolute; 
                top: 0; 
                bottom: 0; 
                width: 100%; 
            }
            .leaflet-popup-content { 
                font-size: 14px; 
                line-height: 1.4;
            }
            .leaflet-control-zoom {
                margin-top: 180px !important;
            }
            .leaflet-popup-content-wrapper {
                border-radius: 8px;
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            }
        </style>
    ''')
    
    with open(archivo_html, 'w', encoding='utf-8') as f:
        f.write(html_content)
    
    print(f"‚úÖ Mapa con recomendaciones generado: {archivo_html}")
    return archivo_html

# --- 9Ô∏è‚É£ ACTUALIZAR LA LLAMADA FINAL ---
print("üöÄ Generando mapa m√≥vil con sistema de recomendaciones...")
archivo_mapa = generar_mapa_movil_con_recomendaciones(
    start, 
    ong_cercana, 
    segmentos_ruta, 
    waypoints, 
    id_usuario_actual,
    colores_riesgo,
    ongs_cercanas,
    siguiente_recomendacion
)

# Iniciar servidor
url_base = iniciar_servidor_local(8080)

print(f"\n{'='*60}")
print("üì± **MAPA CON SISTEMA DE RECOMENDACIONES**")
print(f"{'='*60}")
print(f"üìç URL local: {url_base}{archivo_mapa}")
print(f"üåê URL red local: http://{obtener_ip_local()}:8080/{archivo_mapa}")
print(f"üìÅ Archivo: {archivo_mapa}")
print(f"üéØ ONG destino actual: {ong_cercana.get('name', 'No disponible')}")
print(f"‚≠ê ONG recomendada: {siguiente_recomendacion.get('name', 'No disponible') if siguiente_recomendacion else 'No disponible'}")
print(f"üìè Distancia recomendada: {siguiente_recomendacion.get('distancia', 0):.1f} km" if siguiente_recomendacion else "üìè No disponible")
print(f"üìä Segmentos de riesgo: {len(segmentos_ruta)}")
print(f"üìç ONGs en mapa: {len(waypoints)}")
print(f"{'='*60}")
print("üí° **Nuevas caracter√≠sticas:**")
print("‚Ä¢ ‚≠ê Nueva pesta√±a de Recomendaciones")
print("‚Ä¢ üéØ Marcador naranja para la ONG recomendada")
print("‚Ä¢ üìã Lista de ONGs cercanas adicionales")
print("‚Ä¢ üó∫Ô∏è Panel mejorado con 4 pesta√±as organizadas")
print("‚Ä¢ üì± Interfaz optimizada para m√≥viles")
print(f"{'='*60}")

# Opcional: Abrir autom√°ticamente en el navegador
try:
    webbrowser.open(f"{url_base}{archivo_mapa}")
    print("üåê Abriendo mapa en navegador...")
except:
    pass
